angular.module("angucomplete",[]).directive("angucomplete",function(e,s,t,i,l){return{restrict:"EA",scope:{id:"@id",placeholder:"@placeholder",selectedObject:"=selectedobject",url:"@url",dataField:"@datafield",titleField:"@titlefield",descriptionField:"@descriptionfield",businessCount:"@businesscount",imageField:"@imagefield",imageUri:"@imageuri",inputClass:"@inputclass",userPause:"@pause",localData:"=localdata",searchFields:"@searchfields",minLengthUser:"@minlength",matchClass:"@matchclass"},template:'<div class="angucomplete-holder"><input id="{{id}}_value" ng-model="searchStr" type="text" placeholder="{{placeholder}}" class="{{inputClass}}" onmouseup="this.select();" ng-focus="resetHideResults()"  /><div id="{{id}}_dropdown" class="angucomplete-dropdown" ng-if="showDropdown"><div class="angucomplete-searching" ng-show="searching">搜索中...</div><div class="angucomplete-searching" ng-show="!searching && (!results || results.length == 0)">没有找到您搜索的内容...</div><div class="angucomplete-row" ng-if="businessList">{{strValue}}<span class="angucomplete-count">{{ businessList }}个结果</span></div><div class="angucomplete-row" ng-repeat="result in results" ng-click="selectResult(result, $event)" ng-mouseover="hoverRow()" ng-class="{\'angucomplete-selected-row\': $index == currentIndex}"><div ng-if="imageField" class="angucomplete-image-holder"><img ng-if="result.image && result.image != \'\'" ng-src="{{result.image}}" class="angucomplete-image"/><div ng-if="!result.image && result.image != \'\'" class="angucomplete-image-default"></div></div><div class="angucomplete-title" ng-if="matchClass" ng-bind-html="result.title"></div><div class="angucomplete-title" ng-if="!matchClass">{{ result.title }}<span class="angucomplete-count" ng-if="result.count">{{ result.count }}家商户可用</span></div><div ng-if="result.description && result.description != \'\'" class="angucomplete-description">{{result.description}}</div></div></div></div>',link:function(e,n){e.lastSearchTerm=null,e.currentIndex=null,e.justChanged=!1,e.searchTimer=null,e.hideTimer=null,e.searching=!1,e.pause=500,e.minLength=3,e.searchStr=null,e.minLengthUser&&""!=e.minLengthUser&&(e.minLength=e.minLengthUser),e.userPause&&(e.pause=e.userPause),isNewSearchNeeded=function(s,t){return s.length>=e.minLength&&s!=t},e.processResults=function(s,i){if(s&&s.length>0){e.results=[];var l=[];e.titleField&&""!=e.titleField&&(l=e.titleField.split(","));for(var n=0;n<s.length;n++){for(var r=[],a=0;a<l.length;a++)r.push(s[n][l[a]]);var c="";e.descriptionField&&(c=s[n][e.descriptionField]);var u="";e.businessCount&&(u=s[n][e.businessCount]);var o="";e.imageUri&&(o=e.imageUri);var d="";e.imageField&&(d=o+s[n][e.imageField]);var p=r.join(" ");if(e.matchClass){var g=new RegExp(i,"i"),h=p.match(g)[0];p=t.trustAsHtml(p.replace(g,'<span class="'+e.matchClass+'">'+h+"</span>"))}var m={title:p,description:c,count:u,image:d,originalObject:s[n]};e.results[e.results.length]=m}}else e.results=[]},e.searchTimerComplete=function(t){if(t.length>=e.minLength)if(e.localData){for(var i=e.searchFields.split(","),l=[],n=0;n<e.localData.length;n++){for(var r=!1,a=0;a<i.length;a++)r=r||"string"==typeof e.localData[n][i[a]]&&"string"==typeof t&&e.localData[n][i[a]].toLowerCase().indexOf(t.toLowerCase())>=0;r&&(l[l.length]=e.localData[n])}e.searching=!1,e.processResults(l,t)}else{var c={msgVersion:"1.29",reqAppId:"ios_pinganhui",custString:"1.29",platform:"ios",city:window.sessionStorage.getItem("city"),reqTime:(new Date).getTime()};e.strValue=t,s.jsonp(e.url+t,{params:c}).success(function(s){e.searching=!1;var i=s.body.result.deal_list;s.body.result.business_count&&(e.businessList=s.body.result.business_count),e.processResults(e.dataField?s[e.dataField]:i,t)}).error(function(){console.log("error")})}},e.hideResults=function(){e.hideTimer=i(function(){e.showDropdown=!1},e.pause)},e.resetHideResults=function(){e.hideTimer&&i.cancel(e.hideTimer)},e.hoverRow=function(s){e.currentIndex=s},e.keyPressed=function(s){38!=s.which&&40!=s.which&&13!=s.which?e.searchStr&&""!=e.searchStr?isNewSearchNeeded(e.searchStr,e.lastSearchTerm)&&(e.lastSearchTerm=e.searchStr,e.showDropdown=!0,e.currentIndex=-1,e.results=[],e.searchTimer&&i.cancel(e.searchTimer),e.searching=!0,e.searchTimer=i(function(){e.searchTimerComplete(e.searchStr)},e.pause)):(e.showDropdown=!1,e.lastSearchTerm=null):s.preventDefault()},e.selectResult=function(s){l.path("item/"+s.originalObject.deal_id),e.matchClass&&(s.title=s.title.toString().replace(/(<([^>]+)>)/gi,"")),e.searchStr=e.lastSearchTerm=s.title,e.selectedObject=s,e.showDropdown=!1,e.results=[]};var r=n.find("input");r.on("input",e.keyPressed),n.on("input",function(s){40===s.which?(e.results&&e.currentIndex+1<e.results.length&&(e.currentIndex++,e.$apply(),s.preventDefault,s.stopPropagation()),e.$apply()):38==s.which?e.currentIndex>=1&&(e.currentIndex--,e.$apply(),s.preventDefault,s.stopPropagation()):13==s.which?e.results&&e.currentIndex>=0&&e.currentIndex<e.results.length?(e.selectResult(e.results[e.currentIndex]),e.$apply(),s.preventDefault,s.stopPropagation()):(e.results=[],e.$apply(),s.preventDefault,s.stopPropagation()):27==s.which?(e.results=[],e.showDropdown=!1,e.$apply()):8==s.which&&(e.selectedObject=null,e.$apply())})}}});